- name: ensure required rpms for logging are installed
  yum: name={{ item }} state=present
  with_items:
    - xz
    - tar

- name: aggregate all covereage data
  shell: coverage combine --append --rcfile=/coverage/.coveragerc
  args:
      chdir: /coverage

- name: generate html coverage report
  shell: coverage html --rcfile=/coverage/.coveragerc
  args:
      chdir: /coverage

- name: generate plain text coverage overview
  shell: "coverage report --rcfile=/coverage/.coveragerc &> ./coverage_{{ inventory_hostname }}/coverage_{{ inventory_hostname }}.txt"
  args:
      chdir: /coverage

- name: append combined data file to collected report
  shell: "cp /coverage/.coverage /coverage/coverage_{{ inventory_hostname }}/combined_data"

- name: pack coverage report
  shell: "tar cJf ./coverage_{{ inventory_hostname }}.tar.xz ./coverage_{{ inventory_hostname }}"
  args:
      chdir: /coverage

- name: fetch log archive and coverage report
  fetch:
      src: "/coverage/coverage_{{ inventory_hostname }}.tar.xz"
      flat: yes
      dest: "{{ inventory_dir }}/collected_coverage_files/coverage_{{ inventory_hostname }}.tar.xz"
